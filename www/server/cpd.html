<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">










<html>
  <head>
    <title>James Server - CPD Results</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
      </head>
  <body class="composite">
    <div id="banner">
                  <a href="http://james.apache.org/index.html" id="bannerLeft">
    
                                            <img src="images/james-server-logo.gif" alt="" />
    
            </a>
                        <a href="http://www.apache.org/index.html" id="bannerRight">
    
                                            <img src="images/asf-logo-reduced.gif" alt="" />
    
            </a>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
          
  

  
    
  
  
            <div class="xleft">
        Last Published: 07/26/2006
                      </div>
            <div class="xright">      <a href="http://james.apache.org/index.html">JAMES Project</a>
          |
          <a href="">Server</a>
          |
          <a href="http://james.apache.org/jspf/index.html">jSPF</a>
          |
          <a href="http://james.apache.org/mime4j/index.html">Mime4J</a>
          |
          <a href="http://james.apache.org/jsieve/index.html">JSieve</a>
          |
          <a href="http://james.apache.org/postage/index.html">Postage</a>
          
  

  
    
  
  
  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
           
  

  
    
  
  
                   <h5>James</h5>
        <ul>
              
    <li class="none">
              <a href="index.html">Overview</a>
        </li>
              
    <li class="none">
              <a href="FAQ.html">James FAQ</a>
        </li>
              
    <li class="none">
              <a href="mail.html">Mailing Lists</a>
        </li>
              
    <li class="none">
              <a href="http://wiki.apache.org/james">Wiki</a>
        </li>
          </ul>
          <h5>Documentation</h5>
        <ul>
              
    <li class="none">
              <a href="documentation_2_1.html">James</a>
        </li>
              
    <li class="none">
              <a href="design_objectives.html">Design</a>
        </li>
              
    <li class="none">
              <a href="document_archive.html">Document Archive</a>
        </li>
          </ul>
          <h5>Documentation 2.3B</h5>
        <ul>
              
    <li class="none">
              <a href="documentation_2_3.html">James</a>
        </li>
              
    <li class="none">
              <a href="design_objectives_2_3.html">Design</a>
        </li>
              
    <li class="none">
              <a href="apidocs/index.html">James Javadocs</a>
        </li>
              
    <li class="none">
              <a href="rfclist.html">Useful RFCs</a>
        </li>
          </ul>
          <h5>Project</h5>
        <ul>
              
    <li class="none">
              <a href="http://issues.apache.org/jira/browse/JAMES">Bug Database</a>
        </li>
              
    <li class="none">
              <a href="http://svn.apache.org/viewvc/james/server/">Source Code</a>
        </li>
              
    <li class="none">
              <a href="changelog.html">Changelog</a>
        </li>
              
    <li class="none">
              <a href="todo.html">TODO</a>
        </li>
          </ul>
          <h5>Project Documentation</h5>
        <ul>
              
                
              
      
            
      
            
      
            
      
            
      
            
      
            
      
              
        <li class="collapsed">
              <a href="project-info.html">Project Information</a>
              </li>
              
                
              
            
            
      
            
      
            
      
              
            <li class="expanded">
              <a href="project-reports.html">Project Reports</a>
                <ul>
                  
    <li class="none">
              <strong>CPD Report</strong>
        </li>
                  
    <li class="none">
              <a href="apidocs/index.html">JavaDocs</a>
        </li>
                  
    <li class="none">
              <a href="pmd.html">PMD Report</a>
        </li>
                  
    <li class="none">
              <a href="jxr.html">Source Xref</a>
        </li>
              </ul>
        </li>
          </ul>
                                       <a href="http://maven.apache.org/" title="Built by Maven" id="poweredBy">
            <img alt="Built by Maven" src="./images/logos/maven-feather.png"></img>
          </a>
                       
  

  
    
  
  
        </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section"><h2>CPD Results</h2><p>The following document contains the results of PMD's  <a href="http://pmd.sourceforge.net/cpd.html">CPD</a> 3.7.</p></div><div class="section"><h2>Duplications</h2><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\BayesianAnalysis.java</td><td><a href="./xref/org/apache/james/transport/mailets/BayesianAnalysis.html#385">385</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#677">677</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        }
    }
    
    private void sendReplyFromPostmaster(Mail mail, String stringContent) throws MessagingException {
        try {
            MailAddress notifier = getMailetContext().getPostmaster();
            
            MailAddress senderMailAddress = mail.getSender();
            
            MimeMessage message = mail.getMessage();
            //Create the reply message
            MimeMessage reply = new MimeMessage(Session.getDefaultInstance(System.getProperties(), null));
            
            //Create the list of recipients in the Address[] format
            InternetAddress[] rcptAddr = new InternetAddress[1];
            rcptAddr[0] = senderMailAddress.toInternetAddress();
            reply.setRecipients(Message.RecipientType.TO, rcptAddr);
            
            //Set the sender...
            reply.setFrom(notifier.toInternetAddress());
            
            //Create the message body
            MimeMultipart multipart = new MimeMultipart();
            //Add message as the first mime body part
            MimeBodyPart part = new MimeBodyPart();
            part.setContent(stringContent, &quot;text/plain&quot;);
            part.setHeader(RFC2822Headers.CONTENT_TYPE, &quot;text/plain&quot;);
            multipart.addBodyPart(part);
            
            reply.setContent(multipart);
            reply.setHeader(RFC2822Headers.CONTENT_TYPE, multipart.getContentType());
            
            //Create the list of recipients in our MailAddress format
            Set recipients = new HashSet();
            recipients.add(senderMailAddress);
            
            //Set additional headers
            if (reply.getHeader(RFC2822Headers.DATE)==null){
                reply.setHeader(RFC2822Headers.DATE, rfc822DateFormat.format(new java.util.Date()));
            }
            String subject = message.getSubject();
            if (subject == null) {
                subject = &quot;&quot;;
            }
            if (subject.indexOf(&quot;Re:&quot;) == 0){
                reply.setSubject(subject);
            } else {
                reply.setSubject(&quot;Re:&quot; + subject);
            }
            reply.setHeader(RFC2822Headers.IN_REPLY_TO, message.getMessageID());
            
            //Send it off...
            getMailetContext().sendMail(notifier, recipients, reply);
        }
        catch (Exception e) {
            log(&quot;Exception found sending reply&quot;, e);
        }
    }
    
    /** Gets the main name of a local customer, handling alias */
    private String getPrimaryName(String originalUsername) {</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\CommandListservProcessor.java</td><td><a href="./xref/org/apache/james/transport/mailets/CommandListservProcessor.html#420">420</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\GenericListserv.java</td><td><a href="./xref/org/apache/james/transport/mailets/GenericListserv.html#83">83</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>    }

    /**
     * &lt;p&gt;This takes the subject string and reduces (normailzes) it.
     * Multiple &quot;Re:&quot; entries are reduced to one, and capitalized.  The
     * prefix is always moved/placed at the beginning of the line, and
     * extra blanks are reduced, so that the output is always of the
     * form:&lt;/p&gt;
     * &lt;code&gt;
     * &amp;lt;prefix&amp;gt; + &amp;lt;one-optional-&quot;Re:&quot;*gt; + &amp;lt;remaining subject&amp;gt;
     * &lt;/code&gt;
     * &lt;p&gt;I have done extensive testing of this routine with a standalone
     * driver, and am leaving the commented out debug messages so that
     * when someone decides to enhance this method, it can be yanked it
     * from this file, embedded it with a test driver, and the comments
     * enabled.&lt;/p&gt;
     */
    static private String normalizeSubject(final String subj, final String prefix) {
        // JDK IMPLEMENTATION NOTE!  When we require JDK 1.4+, all
        // occurrences of subject.toString.().indexOf(...) can be
        // replaced by subject.indexOf(...).

        StringBuffer subject = new StringBuffer(subj);
        int prefixLength = prefix.length();

        // System.err.println(&quot;In:  &quot; + subject);

        // If the &quot;prefix&quot; is not at the beginning the subject line, remove it
        int index = subject.toString().indexOf(prefix);
        if (index != 0) {
            // System.err.println(&quot;(p) index: &quot; + index + &quot;, subject: &quot; + subject);
            if (index &gt; 0) {
                subject.delete(index, index + prefixLength);
            }
            subject.insert(0, prefix); // insert prefix at the front
        }

        // Replace Re: with RE:
        String match = &quot;Re:&quot;;
        index = subject.toString().indexOf(match, prefixLength);

        while(index &gt; -1) {
            // System.err.println(&quot;(a) index: &quot; + index + &quot;, subject: &quot; + subject);
            subject.replace(index, index + match.length(), &quot;RE:&quot;);
            index = subject.toString().indexOf(match, prefixLength);
            // System.err.println(&quot;(b) index: &quot; + index + &quot;, subject: &quot; + subject);
        }

        // Reduce them to one at the beginning
        match =&quot;RE:&quot;;
        int indexRE = subject.toString().indexOf(match, prefixLength) + match.length();
        index = subject.toString().indexOf(match, indexRE);
        while(index &gt; 0) {
            // System.err.println(&quot;(c) index: &quot; + index + &quot;, subject: &quot; + subject);
            subject.delete(index, index + match.length());
            index = subject.toString().indexOf(match, indexRE);
            // System.err.println(&quot;(d) index: &quot; + index + &quot;, subject: &quot; + subject);
        }

        // Reduce blanks
        match = &quot;  &quot;;
        index = subject.toString().indexOf(match, prefixLength);
        while(index &gt; -1) {
            // System.err.println(&quot;(e) index: &quot; + index + &quot;, subject: &quot; + subject);
            subject.replace(index, index + match.length(), &quot; &quot;);
            index = subject.toString().indexOf(match, prefixLength);
            // System.err.println(&quot;(f) index: &quot; + index + &quot;, subject: &quot; + subject);
        }


        // System.err.println(&quot;Out: &quot; + subject);

        return subject.toString();
    }</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\mailrepository\AvalonMailRepository.java</td><td><a href="./xref/org/apache/james/mailrepository/AvalonMailRepository.html#180">180</a></td></tr><tr class="a"><td>org\apache\james\mailrepository\JDBCMailRepository.java</td><td><a href="./xref/org/apache/james/mailrepository/JDBCMailRepository.html#490">490</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>    }

    /**
     * Releases a lock on a message identified by a key
     *
     * @param key the key of the message to be unlocked
     *
     * @return true if successfully released the lock, false otherwise
     */
    public boolean unlock(String key) {
        if (lock.unlock(key)) {
            if ((DEEP_DEBUG) &amp;&amp; (getLogger().isDebugEnabled())) {
                StringBuffer debugBuffer =
                    new StringBuffer(256)
                            .append(&quot;Unlocked &quot;)
                            .append(key)
                            .append(&quot; for &quot;)
                            .append(Thread.currentThread().getName())
                            .append(&quot; @ &quot;)
                            .append(new java.util.Date(System.currentTimeMillis()));
                getLogger().debug(debugBuffer.toString());
            }
            return true;
        } else {
            return false;
        }
    }

    /**
     * Obtains a lock on a message identified by a key
     *
     * @param key the key of the message to be locked
     *
     * @return true if successfully obtained the lock, false otherwise
     */
    public boolean lock(String key) {
        if (lock.lock(key)) {
            if ((DEEP_DEBUG) &amp;&amp; (getLogger().isDebugEnabled())) {
                StringBuffer debugBuffer =
                    new StringBuffer(256)
                            .append(&quot;Locked &quot;)
                            .append(key)
                            .append(&quot; for &quot;)
                            .append(Thread.currentThread().getName())
                            .append(&quot; @ &quot;)
                            .append(new java.util.Date(System.currentTimeMillis()));
                getLogger().debug(debugBuffer.toString());
            }
            return true;
        } else {
            return false;
        }
    }

    /**
     * Store this message to the database.  Optionally stores the message
     * body to the filesystem and only writes the headers to the database.
     */
    public void store(Mail mc) throws MessagingException {</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#454">454</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#577">577</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>            out.println(&quot;Removing from the white list of &quot; + (new MailAddress(senderUser, senderHost)) + &quot; ...&quot;);
            out.println();
            
            MimeMessage message = mail.getMessage() ;
            
            Object content= message.getContent();
            
            if (message.getContentType().startsWith(&quot;text/plain&quot;)
            &amp;&amp; content instanceof String) {
                StringTokenizer st = new StringTokenizer((String) content, &quot; \t\n\r\f,;:&lt;&gt;&quot;);
                while (st.hasMoreTokens()) {
                    ResultSet selectRS = null;
                    try {
                        MailAddress recipientMailAddress;
                        try {
                            recipientMailAddress = new MailAddress(st.nextToken());
                        }
                        catch (javax.mail.internet.ParseException pe) {
                            continue;
                        }
                        String recipientUser = recipientMailAddress.getUser().toLowerCase(Locale.US);
                        String recipientHost = recipientMailAddress.getHost().toLowerCase(Locale.US);
                        
                        if (getMailetContext().isLocalServer(recipientHost)) {
                            // not a remote recipient, so skip
                            continue;
                        }
                        
                        if (conn == null) {
                            conn = datasource.getConnection();
                        }
                        
                        if (selectStmt == null) {
                            selectStmt = conn.prepareStatement(selectByPK);
                        }
                        selectStmt.setString(1, senderUser);
                        selectStmt.setString(2, senderHost);
                        selectStmt.setString(3, recipientUser);
                        selectStmt.setString(4, recipientHost);
                        selectRS = selectStmt.executeQuery();
                        if (!selectRS.next()) {</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\ClamAVScan.java</td><td><a href="./xref/org/apache/james/transport/mailets/ClamAVScan.html#717">717</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\smime\SMIMEAbstractSign.java</td><td><a href="./xref/org/apache/james/transport/mailets/smime/SMIMEAbstractSign.html#563">563</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>    private void checkInitParameters(String[] allowedArray) throws MessagingException {
        // if null then no check is requested
        if (allowedArray == null) {
            return;
        }
        
        Collection allowed = new HashSet();
        Collection bad = new ArrayList();
        
        for (int i = 0; i &lt; allowedArray.length; i++) {
            allowed.add(allowedArray[i]);
        }
        
        Iterator iterator = getInitParameterNames();
        while (iterator.hasNext()) {
            String parameter = (String) iterator.next();
            if (!allowed.contains(parameter)) {
                bad.add(parameter);
            }
        }
        
        if (bad.size() &gt; 0) {
            throw new MessagingException(&quot;Unexpected init parameters found: &quot;
            + arrayToString(bad.toArray()));
        }
    }
    
    /**
     * Utility method for obtaining a string representation of an array of Objects.
     */
    private final String arrayToString(Object[] array) {
        if (array == null) {
            return &quot;null&quot;;
        }
        StringBuffer sb = new StringBuffer(1024);
        sb.append(&quot;[&quot;);
        for (int i = 0; i &lt; array.length; i++) {
            if (i &gt; 0) {
                sb.append(&quot;,&quot;);
            }
            sb.append(array[i]);
        }
        sb.append(&quot;]&quot;);
        return sb.toString();
    }
    
    /**
     * Utility method that checks if there is at least one address in the &quot;From:&quot; header
     * same as the &lt;i&gt;reverse-path&lt;/i&gt;.
     * @param mail The mail to check.
     * @return True if an address is found, false otherwise.
     */    
    protected final boolean fromAddressSameAsReverse(Mail mail) {</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#206">206</a></td></tr><tr class="a"><td>org\apache\james\transport\matchers\IsInWhiteList.java</td><td><a href="./xref/org/apache/james/transport/matchers/IsInWhiteList.html#115">115</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        if (repositoryPath != null) {
            log(&quot;repositoryPath: &quot; + repositoryPath);
        }
        else {
            throw new MessagingException(&quot;repositoryPath is null&quot;);
        }

        ServiceManager serviceManager = (ServiceManager) getMailetContext().getAttribute(Constants.AVALON_COMPONENT_MANAGER);

        try {
            // Get the DataSourceSelector block
            DataSourceSelector datasources = (DataSourceSelector) serviceManager.lookup(DataSourceSelector.ROLE);
            // Get the data-source required.
            int stindex =   repositoryPath.indexOf(&quot;://&quot;) + 3;
            String datasourceName = repositoryPath.substring(stindex);
            datasource = (DataSourceComponent) datasources.select(datasourceName);
        } catch (Exception e) {
            throw new MessagingException(&quot;Can't get datasource&quot;, e);
        }

         try {
            // Get the UsersRepository
            usersStore = (UsersStore)serviceManager.lookup(UsersStore.ROLE);
            localusers = (UsersRepository)usersStore.getRepository(&quot;LocalUsers&quot;);
        } catch (Exception e) {
            throw new MessagingException(&quot;Can't get the local users repository&quot;, e);
        }

        try {
            initSqlQueries(datasource.getConnection(), getMailetContext());
        } catch (Exception e) {
            throw new MessagingException(&quot;Exception initializing queries&quot;, e);
        }        
        
        selectByPK = sqlQueries.getSqlString(&quot;selectByPK&quot;, true);</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\pop3server\ListCmdHandler.java</td><td><a href="./xref/org/apache/james/pop3server/ListCmdHandler.html#100">100</a></td></tr><tr class="a"><td>org\apache\james\pop3server\UidlCmdHandler.java</td><td><a href="./xref/org/apache/james/pop3server/UidlCmdHandler.html#74">74</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>                                    .append(mc.getName());
                        responseString = responseBuffer.toString();
                        session.writeResponse(responseString);
                    } else {
                        StringBuffer responseBuffer =
                            new StringBuffer(64)
                                    .append(POP3Handler.ERR_RESPONSE)
                                    .append(&quot; Message (&quot;)
                                    .append(num)
                                    .append(&quot;) already deleted.&quot;);
                        responseString = responseBuffer.toString();
                        session.writeResponse(responseString);
                    }
                } catch (IndexOutOfBoundsException npe) {
                    StringBuffer responseBuffer =
                        new StringBuffer(64)
                                .append(POP3Handler.ERR_RESPONSE)
                                .append(&quot; Message (&quot;)
                                .append(num)
                                .append(&quot;) does not exist.&quot;);
                    responseString = responseBuffer.toString();
                    session.writeResponse(responseString);
                } catch (NumberFormatException nfe) {
                    StringBuffer responseBuffer =
                        new StringBuffer(64)
                                .append(POP3Handler.ERR_RESPONSE)
                                .append(&quot; &quot;)
                                .append(argument)
                                .append(&quot; is not a valid number&quot;);
                    responseString = responseBuffer.toString();
                    session.writeResponse(responseString);
                }</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\pop3server\POP3Handler.java</td><td><a href="./xref/org/apache/james/pop3server/POP3Handler.html#185">185</a></td></tr><tr class="a"><td>org\apache\james\smtpserver\SMTPHandler.java</td><td><a href="./xref/org/apache/james/smtpserver/SMTPHandler.html#201">201</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        String responseString = clearResponseBuffer();
        writeLoggedFlushedResponse(responseString);

        //the core in-protocol handling logic
        //run all the connection handlers, if it fast fails, end the session
        //parse the command command, look up for the list of command handlers
        //Execute each of the command handlers. If any command handlers writes
        //response then, End the subsequent command handler processing and
        //start parsing new command. Once the message is received, run all
        //the message handlers. The message handlers can either terminate
        //message or terminate session

        //At the beginning
        //mode = command_mode
        //once the commandHandler writes response, the mode is changed to RESPONSE_MODE.
        //This will cause to skip the subsequent command handlers configured for that command.
        //For instance:
        //There are 2 commandhandlers MailAddressChecker and MailCmdHandler for
        //MAIL command. If MailAddressChecker validation of the MAIL FROM
        //address is successful, the MailCmdHandlers will be executed.
        //Incase it fails, it has to write response. Once we write response
        //there is no need to execute the MailCmdHandler.
        //Next, Once MAIL message is received the DataCmdHandler and any other
        //equivalent commandHandler will call setMail method. this will change
        //he mode to MAIL_RECEIVED_MODE. This mode will trigger the message
        //handlers to be execute. Message handlers can abort message. In that case,
        //message will not spooled.

        //Session started - RUN all connect handlers
        List connectHandlers = handlerChain.getConnectHandlers();
        if(connectHandlers != null) {
            int count = connectHandlers.size();
            for(int i = 0; i &lt; count; i++) {
                ((ConnectHandler)connectHandlers.get(i)).onConnect(this);
                if(sessionEnded) {
                    break;
                }
            }
        }

        theWatchdog.start();
        while(!sessionEnded) {
          //Reset the current command values
          curCommandName = null;
          curCommandArgument = null;
          mode = COMMAND_MODE;

          //parse the command
          String cmdString =  readCommandLine();
          if (cmdString == null) {
              break;
          }
          int spaceIndex = cmdString.indexOf(&quot; &quot;);
          if (spaceIndex &gt; 0) {
              curCommandName = cmdString.substring(0, spaceIndex);
              curCommandArgument = cmdString.substring(spaceIndex + 1);
          } else {
              curCommandName = cmdString;
          }
          curCommandName = curCommandName.toUpperCase(Locale.US);</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\AbstractRedirect.java</td><td><a href="./xref/org/apache/james/transport/mailets/AbstractRedirect.html#395">395</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\Redirect.java</td><td><a href="./xref/org/apache/james/transport/mailets/Redirect.html#331">331</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        String addressList = getInitParameter(&quot;recipients&quot;,getInitParameter(&quot;to&quot;));
                                 
        // if nothing was specified, return &lt;CODE&gt;null&lt;/CODE&gt; meaning no change
        if (addressList == null) {
            return null;
        }

        try {
            InternetAddress[] iaarray = InternetAddress.parse(addressList, false);
            for (int i = 0; i &lt; iaarray.length; i++) {
                String addressString = iaarray[i].getAddress();
                MailAddress specialAddress = getSpecialAddress(addressString,
                new String[] {&quot;postmaster&quot;, &quot;sender&quot;, &quot;from&quot;, &quot;replyTo&quot;, &quot;reversePath&quot;, &quot;unaltered&quot;, &quot;recipients&quot;, &quot;to&quot;, &quot;null&quot;});
                if (specialAddress != null) {
                    newRecipients.add(specialAddress);
                } else {
                    newRecipients.add(new MailAddress(iaarray[i]));
                }
            }
        } catch (Exception e) {
            throw new MessagingException(&quot;Exception thrown in getRecipients() parsing: &quot; + addressList, e);
        }
        if (newRecipients.size() == 0) {
            throw new MessagingException(&quot;Failed to initialize \&quot;recipients\&quot; list; empty &lt;recipients&gt; init parameter found.&quot;);
        }

        return newRecipients;
    }

    /**
     * @return the &lt;CODE&gt;to&lt;/CODE&gt; init parameter
     * or the postmaster address
     * or &lt;CODE&gt;SpecialAddress.SENDER&lt;/CODE&gt;
     * or &lt;CODE&gt;SpecialAddress.REVERSE_PATH&lt;/CODE&gt;
     * or &lt;CODE&gt;SpecialAddress.UNALTERED&lt;/CODE&gt;
     * or the &lt;CODE&gt;recipients&lt;/CODE&gt; init parameter if missing
     * or &lt;CODE&gt;null&lt;/CODE&gt; if also the latter is missing
     */
    protected InternetAddress[] getTo() throws MessagingException {</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\Forward.java</td><td><a href="./xref/org/apache/james/transport/mailets/Forward.html#116">116</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\Redirect.java</td><td><a href="./xref/org/apache/james/transport/mailets/Redirect.html#336">336</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        }

        try {
            InternetAddress[] iaarray = InternetAddress.parse(addressList, false);
            for (int i = 0; i &lt; iaarray.length; i++) {
                String addressString = iaarray[i].getAddress();
                MailAddress specialAddress = getSpecialAddress(addressString,
                new String[] {&quot;postmaster&quot;, &quot;sender&quot;, &quot;from&quot;, &quot;replyTo&quot;, &quot;reversePath&quot;, &quot;unaltered&quot;, &quot;recipients&quot;, &quot;to&quot;, &quot;null&quot;});
                if (specialAddress != null) {
                    newRecipients.add(specialAddress);
                } else {
                    newRecipients.add(new MailAddress(iaarray[i]));
                }
            }
        } catch (Exception e) {
            throw new MessagingException(&quot;Exception thrown in getRecipients() parsing: &quot; + addressList, e);
        }
        if (newRecipients.size() == 0) {
            throw new MessagingException(&quot;Failed to initialize \&quot;recipients\&quot; list; empty &lt;recipients&gt; init parameter found.&quot;);
        }

        return newRecipients;
    }

    /**
     * @return the &lt;CODE&gt;to&lt;/CODE&gt; init parameter
     * or the postmaster address
     * or &lt;CODE&gt;SpecialAddress.SENDER&lt;/CODE&gt;
     * or &lt;CODE&gt;SpecialAddress.REVERSE_PATH&lt;/CODE&gt;
     * or &lt;CODE&gt;SpecialAddress.UNALTERED&lt;/CODE&gt;
     * or the &lt;CODE&gt;recipients&lt;/CODE&gt; init parameter if missing
     * or &lt;CODE&gt;null&lt;/CODE&gt; if also the latter is missing
     */
    protected InternetAddress[] getTo() throws MessagingException {</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\util\BayesianAnalyzer.java</td><td><a href="./xref/org/apache/james/util/BayesianAnalyzer.html#369">369</a></td></tr><tr class="a"><td>org\apache\james\util\BayesianAnalyzer.java</td><td><a href="./xref/org/apache/james/util/BayesianAnalyzer.html#421">421</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        String token;
        String header = &quot;&quot;;
        
        //Build a Map of tokens encountered.
        while ((token = nextToken(stream)) != null) {
            boolean endingLine = false;
            if (token.length() &gt; 0 &amp;&amp; token.charAt(token.length() - 1) == '\n') {
                endingLine = true;
                token = token.substring(0, token.length() - 1);
            }
            
            if (token.length() &gt; 0 &amp;&amp; header.length() + token.length() &lt; 90 &amp;&amp; !allDigits(token)) {
                if (token.equals(&quot;From:&quot;)
                || token.equals(&quot;Return-Path:&quot;)
                || token.equals(&quot;Subject:&quot;)
                || token.equals(&quot;To:&quot;)
                ) {
                    header = token;
                    if (!endingLine) {
                        continue;
                    }
                }
                
                token = header + token;</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\smtpserver\core\filter\fastfail\ResolvableEhloHeloHandler.java</td><td><a href="./xref/org/apache/james/smtpserver/core/filter/fastfail/ResolvableEhloHeloHandler.html#36">36</a></td></tr><tr class="a"><td>org\apache\james\smtpserver\core\filter\fastfail\ReverseEqualsEhloHeloHandler.java</td><td><a href="./xref/org/apache/james/smtpserver/core/filter/fastfail/ReverseEqualsEhloHeloHandler.html#36">36</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>public class ReverseEqualsEhloHeloHandler extends AbstractLogEnabled
        implements CommandHandler, Configurable, Serviceable {

    private boolean checkAuthNetworks = false;

    private DNSServer dnsServer = null;

    /**
     * @see org.apache.avalon.framework.configuration.Configurable#configure(Configuration)
     */
    public void configure(Configuration handlerConfiguration)
            throws ConfigurationException {
        Configuration configRelay = handlerConfiguration.getChild(
                &quot;checkAuthNetworks&quot;, false);
        if (configRelay != null) {
            setCheckAuthNetworks(configRelay.getValueAsBoolean(false));
        }
    }

    /**
     * @see org.apache.avalon.framework.service.Serviceable#service(ServiceManager)
     */
    public void service(ServiceManager serviceMan) throws ServiceException {
        setDnsServer((DNSServer) serviceMan.lookup(DNSServer.ROLE));
    }

    /**
     * Set to true if AuthNetworks should be included in the EHLO check
     * 
     * @param checkAuthNetworks
     *            Set to true to enable
     */
    public void setCheckAuthNetworks(boolean checkAuthNetworks) {
        this.checkAuthNetworks = checkAuthNetworks;
    }

    /**
     * Set the DNSServer
     * 
     * @param dnsServer
     *            The DNSServer
     */
    public void setDnsServer(DNSServer dnsServer) {
        this.dnsServer = dnsServer;
    }

    /**
     * @see org.apache.james.smtpserver.CommandHandler#onCommand(SMTPSession)
     */
    public void onCommand(SMTPSession session) {
        String argument = session.getCommandArgument();
        String responseString = null;

        /**
         * don't check if the ip address is allowed to relay. Only check if it
         * is set in the config. ed.
         */
        if (!session.isRelayingAllowed() || checkAuthNetworks) {
            try {</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\pop3server\POP3HandlerChain.java</td><td><a href="./xref/org/apache/james/pop3server/POP3HandlerChain.html#171">171</a></td></tr><tr class="a"><td>org\apache\james\smtpserver\SMTPHandlerChain.java</td><td><a href="./xref/org/apache/james/smtpserver/SMTPHandlerChain.html#331">331</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>    }

    /**
     * Add it to map (key as command name, value is an array list of commandhandlers)
     *
     * @param commandName the command name which will be key
     * @param cmdHandler The commandhandler object
     */
    private void addToMap(String commandName, CommandHandler cmdHandler) {
        ArrayList handlers = (ArrayList)commandHandlerMap.get(commandName);
        if(handlers == null) {
            handlers = new ArrayList();
            commandHandlerMap.put(commandName, handlers);
        }
        handlers.add(cmdHandler);
    }

    /**
     * Returns all the configured commandhandlers for the specified command
     *
     * @param commandName the command name which will be key
     * @return List of commandhandlers
     */
    List getCommandHandlers(String command) {
        if (command == null) {
            return null;
        }
        if (getLogger().isDebugEnabled()) {
            getLogger().debug(&quot;Lookup command handler for command: &quot; + command);
        }
        List handlers =  (List)commandHandlerMap.get(command);
        if(handlers == null) {
            handlers = (List)commandHandlerMap.get(UnknownCmdHandler.UNKNOWN_COMMAND);
        }

        return handlers;
    }

    /**
     * Returns all the configured message handlers
     *
     * @return List of message handlers
     */
    List getMessageHandlers() {
        return messageHandlers;
    }

    /**
     * Returns all the configured connect handlers
     *
     * @return List of connect handlers
     */
    List getConnectHandlers() {
        return connectHandlers;
    }

}</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\AbstractRedirect.java</td><td><a href="./xref/org/apache/james/transport/mailets/AbstractRedirect.html#400">400</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\Forward.java</td><td><a href="./xref/org/apache/james/transport/mailets/Forward.html#116">116</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        }

        try {
            InternetAddress[] iaarray = InternetAddress.parse(addressList, false);
            for (int i = 0; i &lt; iaarray.length; i++) {
                String addressString = iaarray[i].getAddress();
                MailAddress specialAddress = getSpecialAddress(addressString,
                new String[] {&quot;postmaster&quot;, &quot;sender&quot;, &quot;from&quot;, &quot;replyTo&quot;, &quot;reversePath&quot;, &quot;unaltered&quot;, &quot;recipients&quot;, &quot;to&quot;, &quot;null&quot;});
                if (specialAddress != null) {
                    newRecipients.add(specialAddress);
                } else {
                    newRecipients.add(new MailAddress(iaarray[i]));
                }
            }
        } catch (Exception e) {
            throw new MessagingException(&quot;Exception thrown in getRecipients() parsing: &quot; + addressList, e);
        }
        if (newRecipients.size() == 0) {
            throw new MessagingException(&quot;Failed to initialize \&quot;recipients\&quot; list; empty &lt;recipients&gt; init parameter found.&quot;);
        }

        return newRecipients;
    }

    /**
     * @return null
     */
    protected InternetAddress[] getTo() throws MessagingException {</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#732">732</a></td></tr><tr class="a"><td>org\apache\james\transport\matchers\IsInWhiteList.java</td><td><a href="./xref/org/apache/james/transport/matchers/IsInWhiteList.html#221">221</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>            theJDBCUtil.closeJDBCConnection(conn);
        }
    }

    /** Gets the main name of a local customer, handling alias */
    private String getPrimaryName(String originalUsername) {
        String username;
        try {
            username = localusers.getRealName(originalUsername);
            JamesUser user = (JamesUser) localusers.getUserByName(username);
            if (user.getAliasing()) {
                username = user.getAlias();
            }
        }
        catch (Exception e) {
            username = originalUsername;
        }
        return username;
    }
    
    /**
     * Initializes the sql query environment from the SqlResources file.
     * Will look for conf/sqlResources.xml.
     * Will &lt;I&gt;not&lt;/I&gt; create the database resources, if missing
     * (this task is done, if needed, in the {@link WhiteListManager}
     * initialization routine).
     * @param conn The connection for accessing the database
     * @param mailetContext The current mailet context,
     * for finding the conf/sqlResources.xml file
     * @throws Exception If any error occurs
     */
    public void initSqlQueries(Connection conn, org.apache.mailet.MailetContext mailetContext) throws Exception {
        try {
            if (conn.getAutoCommit()) {
                conn.setAutoCommit(false);
            }
            
            this.sqlFile = new File((String) mailetContext.getAttribute(&quot;confDir&quot;), &quot;sqlResources.xml&quot;).getCanonicalFile();
            sqlQueries.init(this.sqlFile, &quot;WhiteList&quot; , conn, getSqlParameters());</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#782">782</a></td></tr><tr class="a"><td>org\apache\james\util\JDBCBayesianAnalyzer.java</td><td><a href="./xref/org/apache/james/util/JDBCBayesianAnalyzer.html#375">375</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        dbUpdated = createTable(conn, &quot;messageCountsTableName&quot;, &quot;createMessageCountsTable&quot;);
        
        //Commit our changes if necessary.
        if (conn != null &amp;&amp; dbUpdated &amp;&amp; !conn.getAutoCommit()) {
            conn.commit();
            dbUpdated = false;
        }
            
    }
    
    private boolean createTable(Connection conn, String tableNameSqlStringName, String createSqlStringName) throws SQLException {
        String tableName = sqlQueries.getSqlString(tableNameSqlStringName, true);
        
        DatabaseMetaData dbMetaData = conn.getMetaData();

        // Try UPPER, lower, and MixedCase, to see if the table is there.
        if (theJDBCUtil.tableExists(dbMetaData, tableName)) {
            return false;
        }
        
        PreparedStatement createStatement = null;
        
        try {
            createStatement =
                    conn.prepareStatement(sqlQueries.getSqlString(createSqlStringName, true));
            createStatement.execute();
            
            StringBuffer logBuffer = null;
            logBuffer =
                    new StringBuffer(64)
                    .append(&quot;Created table '&quot;)
                    .append(tableName)
                    .append(&quot;' using sqlResources string '&quot;)
                    .append(createSqlStringName)
                    .append(&quot;'.&quot;);</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\AbstractRedirect.java</td><td><a href="./xref/org/apache/james/transport/mailets/AbstractRedirect.html#475">475</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\Redirect.java</td><td><a href="./xref/org/apache/james/transport/mailets/Redirect.html#371">371</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        String addressList = getInitParameter(&quot;to&quot;,getInitParameter(&quot;recipients&quot;));

        // if nothing was specified, return null meaning no change
        if (addressList == null) {
            return null;
        }

        try {
            iaarray = InternetAddress.parse(addressList, false);
            for(int i = 0; i &lt; iaarray.length; ++i) {
                String addressString = iaarray[i].getAddress();
                MailAddress specialAddress = getSpecialAddress(addressString,
                                                new String[] {&quot;postmaster&quot;, &quot;sender&quot;, &quot;from&quot;, &quot;replyTo&quot;, &quot;reversePath&quot;, &quot;unaltered&quot;, &quot;recipients&quot;, &quot;to&quot;, &quot;null&quot;});
                if (specialAddress != null) {
                    iaarray[i] = specialAddress.toInternetAddress();
                }
            }
        } catch (Exception e) {
            throw new MessagingException(&quot;Exception thrown in getTo() parsing: &quot; + addressList, e);
        }
        if (iaarray.length == 0) {
            throw new MessagingException(&quot;Failed to initialize \&quot;to\&quot; list; empty &lt;to&gt; init parameter found.&quot;);
        }

        return iaarray;
    }

    /**
     * @return the &lt;CODE&gt;reversePath&lt;/CODE&gt; init parameter 
     * or the postmaster address
     * or &lt;CODE&gt;SpecialAddress.SENDER&lt;/CODE&gt;
     * or &lt;CODE&gt;SpecialAddress.NULL&lt;/CODE&gt;
     * or &lt;CODE&gt;null&lt;/CODE&gt; if missing
     */
    protected MailAddress getReversePath() throws MessagingException {</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\nntpserver\NNTPHandler.java</td><td><a href="./xref/org/apache/james/nntpserver/NNTPHandler.html#761">761</a></td></tr><tr class="a"><td>org\apache\james\nntpserver\NNTPHandler.java</td><td><a href="./xref/org/apache/james/nntpserver/NNTPHandler.html#824">824</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>                            .append(&quot;221 0 &quot;)
                            .append(param);
                writeLoggedFlushedResponse(respBuffer.toString());
            }
        } else {
            int newArticleNumber = currentArticleNumber;
            if ( group == null ) {
                writeLoggedFlushedResponse(&quot;412 no newsgroup selected&quot;);
                return;
            } else {
                if ( param == null ) {
                    if ( currentArticleNumber &lt; 0 ) {
                        writeLoggedFlushedResponse(&quot;420 no current article selected&quot;);
                        return;
                    } else {
                        article = group.getArticle(currentArticleNumber);
                    }
                }
                else {
                    newArticleNumber = Integer.parseInt(param);
                    article = group.getArticle(newArticleNumber);
                }
                if ( article == null ) {
                    writeLoggedFlushedResponse(&quot;423 no such article number in this group&quot;);
                    return;
                } else {
                    currentArticleNumber = newArticleNumber;
                    String articleID = article.getUniqueID();
                    if (articleID == null) {
                        articleID = &quot;&lt;0&gt;&quot;;
                    }
                    StringBuffer respBuffer =
                        new StringBuffer(128)
                                .append(&quot;221 &quot;)</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#517">517</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#640">640</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>                    log(&quot;Removal request issued by &quot; + senderMailAddress);
                }
                //Commit our changes if necessary.
                if (conn != null &amp;&amp; dbUpdated &amp;&amp; !conn.getAutoCommit()) {
                    conn.commit() ;
                    dbUpdated = false;
                }
            }
            else {
                out.println(&quot;The message must be plain - no action&quot;);
            }
            
            out.println();
            out.println(&quot;Finished&quot;);
            
            sendReplyFromPostmaster(mail, sout.toString());
            
        } catch (SQLException sqle) {
            out.println(&quot;Error accessing the database&quot;);
            sendReplyFromPostmaster(mail, sout.toString());
            throw new MessagingException(&quot;Error accessing the database&quot;, sqle);
        } catch (IOException ioe) {
            out.println(&quot;Error getting message content&quot;);
            sendReplyFromPostmaster(mail, sout.toString());
            throw new MessagingException(&quot;Error getting message content&quot;, ioe);
        } finally {
            theJDBCUtil.closeJDBCStatement(selectStmt);
            theJDBCUtil.closeJDBCStatement(deleteStmt);</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\AbstractRedirect.java</td><td><a href="./xref/org/apache/james/transport/mailets/AbstractRedirect.html#1423">1423</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\smime\SMIMEAbstractSign.java</td><td><a href="./xref/org/apache/james/transport/mailets/smime/SMIMEAbstractSign.html#563">563</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>    private void checkInitParameters(String[] allowedArray) throws MessagingException {
        // if null then no check is requested
        if (allowedArray == null) {
            return;
        }
        
        Collection allowed = new HashSet();
        Collection bad = new ArrayList();
        
        for (int i = 0; i &lt; allowedArray.length; i++) {
            allowed.add(allowedArray[i]);
        }
        
        Iterator iterator = getInitParameterNames();
        while (iterator.hasNext()) {
            String parameter = (String) iterator.next();
            if (!allowed.contains(parameter)) {
                bad.add(parameter);
            }
        }
        
        if (bad.size() &gt; 0) {
            throw new MessagingException(&quot;Unexpected init parameters found: &quot;
            + arrayToString(bad.toArray()));
        }
    }</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\AbstractRedirect.java</td><td><a href="./xref/org/apache/james/transport/mailets/AbstractRedirect.html#1423">1423</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\ClamAVScan.java</td><td><a href="./xref/org/apache/james/transport/mailets/ClamAVScan.html#717">717</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>    protected final void checkInitParameters(String[] allowedArray) throws MessagingException {
        // if null then no check is requested
        if (allowedArray == null) {
            return;
        }
        
        Collection allowed = new HashSet();
        Collection bad = new ArrayList();
        
        for (int i = 0; i &lt; allowedArray.length; i++) {
            allowed.add(allowedArray[i]);
        }
        
        Iterator iterator = getInitParameterNames();
        while (iterator.hasNext()) {
            String parameter = (String) iterator.next();
            if (!allowed.contains(parameter)) {
                bad.add(parameter);
            }
        }
        
        if (bad.size() &gt; 0) {
            throw new MessagingException(&quot;Unexpected init parameters found: &quot;
                    + arrayToString(bad.toArray()));
        }
    }</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\nntpserver\NNTPHandler.java</td><td><a href="./xref/org/apache/james/nntpserver/NNTPHandler.html#763">763</a></td></tr><tr class="a"><td>org\apache\james\nntpserver\NNTPHandler.java</td><td><a href="./xref/org/apache/james/nntpserver/NNTPHandler.html#962">962</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>                writeLoggedResponse(respBuffer.toString());
            }
        } else {
            int newArticleNumber = currentArticleNumber;
            if ( group == null ) {
                writeLoggedFlushedResponse(&quot;412 no newsgroup selected&quot;);
                return;
            } else {
                if ( param == null ) {
                    if ( currentArticleNumber &lt; 0 ) {
                        writeLoggedFlushedResponse(&quot;420 no current article selected&quot;);
                        return;
                    } else {
                        article = group.getArticle(currentArticleNumber);
                    }
                }
                else {
                    newArticleNumber = Integer.parseInt(param);
                    article = group.getArticle(newArticleNumber);
                }
                if ( article == null ) {
                    writeLoggedFlushedResponse(&quot;423 no such article number in this group&quot;);
                    return;
                } else {
                    currentArticleNumber = newArticleNumber;
                    String articleID = article.getUniqueID();
                    if (articleID == null) {
                        articleID = &quot;&lt;0&gt;&quot;;
                    }
                    StringBuffer respBuffer =
                        new StringBuffer(128)
                                .append(&quot;220 &quot;)</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\AbstractRedirect.java</td><td><a href="./xref/org/apache/james/transport/mailets/AbstractRedirect.html#1030">1030</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\DSNBounce.java</td><td><a href="./xref/org/apache/james/transport/mailets/DSNBounce.html#220">220</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        setRecipients(newMail, getRecipients(originalMail), originalMail);
        setTo(newMail, getTo(originalMail), originalMail);
        setSubjectPrefix(newMail, getSubjectPrefix(originalMail), originalMail);
        if(newMail.getMessage().getHeader(RFC2822Headers.DATE) == null) {
            newMail.getMessage().setHeader(RFC2822Headers.DATE,rfc822DateFormat.format(new Date()));
        }
        setReplyTo(newMail, getReplyTo(originalMail), originalMail);
        setReversePath(newMail, getReversePath(originalMail), originalMail);
        setSender(newMail, getSender(originalMail), originalMail);
        setIsReply(newMail, isReply(originalMail), originalMail);

        newMail.getMessage().saveChanges();</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\util\SqlResources.java</td><td><a href="./xref/org/apache/james/util/SqlResources.html#136">136</a></td></tr><tr class="a"><td>org\apache\james\util\XMLResources.java</td><td><a href="./xref/org/apache/james/util/XMLResources.html#139">139</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>                        .append(group)
                        .append(&quot;\' does not exist.&quot;);
            throw new RuntimeException(exceptionBuffer.toString());
        }

        // Get parameters defined within the file as defaults,
        // and use supplied parameters as overrides.
        Map parameters = new HashMap();
        // First read from the &lt;params&gt; element, if it exists.
        Element parametersElement = 
            (Element)(sectionElement.getElementsByTagName(&quot;parameters&quot;).item(0));
        if ( parametersElement != null ) {
            NamedNodeMap params = parametersElement.getAttributes();
            int paramCount = params.getLength();
            for (int i = 0; i &lt; paramCount; i++ ) {
                Attr param = (Attr)params.item(i);
                String paramName = param.getName();
                String paramValue = param.getValue();
                parameters.put(paramName, paramValue);
            }
        }
        // Then copy in the parameters supplied with the call.
        parameters.putAll(configParameters);

        // 2 maps - one for storing default statements,
        // the other for statements with a &quot;for&quot; attribute matching this 
        // connection.
        Map defaultStrings = new HashMap();</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\AbstractRedirect.java</td><td><a href="./xref/org/apache/james/transport/mailets/AbstractRedirect.html#1506">1506</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\AddSubjectPrefix.java</td><td><a href="./xref/org/apache/james/transport/mailets/AddSubjectPrefix.html#108">108</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>    }

    /**
     * It attempts to determine the charset used to encode an &quot;unstructured&quot; RFC
     * 822 header (like Subject). The encoding is specified in RFC 2047. If it
     * cannot determine or the the text is not encoded then it returns null.
     * 
     * Here is an example raw text: Subject:
     * =?iso-8859-2?Q?leg=FAjabb_pr=F3ba_l=F5elemmel?=
     * 
     * TODO: Should we include this in a util class ?
     * 
     * @param rawText
     *            the raw (not decoded) value of the header. Null means that the
     *            header was not present (in this case it always return null).
     * @return the MIME charset name or null if no encoding applied
     */
    static private String determineMailHeaderEncodingCharset(String rawText) {
        if (rawText == null)
            return null;
        int iEncodingPrefix = rawText.indexOf(&quot;=?&quot;);
        if (iEncodingPrefix == -1)
            return null;
        int iCharsetBegin = iEncodingPrefix + 2;
        int iSecondQuestionMark = rawText.indexOf('?', iCharsetBegin);
        if (iSecondQuestionMark == -1)
            return null;
        // safety checks
        if (iSecondQuestionMark == iCharsetBegin)
            return null; // empty charset? impossible
        int iThirdQuestionMark = rawText.indexOf('?', iSecondQuestionMark + 1);
        if (iThirdQuestionMark == -1)
            return null; // there must be one after encoding
        if (-1 == rawText.indexOf(&quot;?=&quot;, iThirdQuestionMark + 1))
            return null; // closing tag
        String mimeCharset = rawText.substring(iCharsetBegin,
                iSecondQuestionMark);
        return mimeCharset;
    }</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\AbstractRedirect.java</td><td><a href="./xref/org/apache/james/transport/mailets/AbstractRedirect.html#1082">1082</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\DSNBounce.java</td><td><a href="./xref/org/apache/james/transport/mailets/DSNBounce.html#579">579</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>    protected String newName(Mail mail) throws MessagingException {
        String oldName = mail.getName();

        // Checking if the original mail name is too long, perhaps because of a
        // loop caused by a configuration error.
        // it could cause a &quot;null pointer exception&quot; in AvalonMailRepository much
        // harder to understand.
        if (oldName.length() &gt; 76) {
            int count = 0;
            int index = 0;
            while ((index = oldName.indexOf('!', index + 1)) &gt;= 0) {
                count++;
            }
            // It looks like a configuration loop. It's better to stop.
            if (count &gt; 7) {
                throw new MessagingException(&quot;Unable to create a new message name: too long.&quot;
                                             + &quot; Possible loop in config.xml.&quot;);
            }
            else {
                oldName = oldName.substring(0, 76);
            }
        }

        StringBuffer nameBuffer =
            new StringBuffer(64)
            .append(oldName)
            .append(&quot;-!&quot;)
            .append(random.nextInt(1048576));
        return nameBuffer.toString();
    }</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#322">322</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#474">474</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>                        String recipientUser = recipientMailAddress.getUser().toLowerCase(Locale.US);
                        String recipientHost = recipientMailAddress.getHost().toLowerCase(Locale.US);
                        
                        if (getMailetContext().isLocalServer(recipientHost)) {
                            // not a remote recipient, so skip
                            continue;
                        }
                        
                        if (conn == null) {
                            conn = datasource.getConnection();
                        }
                        
                        if (selectStmt == null) {
                            selectStmt = conn.prepareStatement(selectByPK);
                        }
                        selectStmt.setString(1, senderUser);
                        selectStmt.setString(2, senderHost);
                        selectStmt.setString(3, recipientUser);
                        selectStmt.setString(4, recipientHost);
                        selectRS = selectStmt.executeQuery();
                        if (selectRS.next()) {</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\BayesianAnalysis.java</td><td><a href="./xref/org/apache/james/transport/mailets/BayesianAnalysis.html#227">227</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\BayesianAnalysisFeeder.java</td><td><a href="./xref/org/apache/james/transport/mailets/BayesianAnalysisFeeder.html#185">185</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        initDb();
        
    }
    
    private void initDb() throws MessagingException {
        
        try {
            ServiceManager serviceManager = (ServiceManager) getMailetContext().getAttribute(Constants.AVALON_COMPONENT_MANAGER);
            
            // Get the DataSourceSelector block
            DataSourceSelector datasources = (DataSourceSelector) serviceManager.lookup(DataSourceSelector.ROLE);
            
            // Get the data-source required.
            int stindex =   repositoryPath.indexOf(&quot;://&quot;) + 3;
            
            String datasourceName = repositoryPath.substring(stindex);
            
            datasource = (DataSourceComponent) datasources.select(datasourceName);
        } catch (Exception e) {
            throw new MessagingException(&quot;Can't get datasource&quot;, e);
        }
        
        try {
            analyzer.initSqlQueries(datasource.getConnection(), getMailetContext());
        } catch (Exception e) {
            throw new MessagingException(&quot;Exception initializing queries&quot;, e);
        }        </pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\pop3server\RetrCmdHandler.java</td><td><a href="./xref/org/apache/james/pop3server/RetrCmdHandler.html#71">71</a></td></tr><tr class="a"><td>org\apache\james\pop3server\TopCmdHandler.java</td><td><a href="./xref/org/apache/james/pop3server/TopCmdHandler.html#91">91</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>                        writeMessageContentTo(mc.getMessage(),nouts,lines);
                        nouts.flush();
                        edouts.checkCRLFTerminator();
                        edouts.flush();
                    } finally {
                        session.writeResponse(&quot;.&quot;);
                    }
                } else {
                    StringBuffer responseBuffer =
                        new StringBuffer(64)
                                .append(POP3Handler.ERR_RESPONSE)
                                .append(&quot; Message (&quot;)
                                .append(num)
                                .append(&quot;) already deleted.&quot;);
                    responseString = responseBuffer.toString();
                    session.writeResponse(responseString);
                }
            } catch (IOException ioe) {
                responseString = POP3Handler.ERR_RESPONSE + &quot; Error while retrieving message.&quot;;
                session.writeResponse(responseString);
            } catch (MessagingException me) {
                responseString = POP3Handler.ERR_RESPONSE + &quot; Error while retrieving message.&quot;;
                session.writeResponse(responseString);
            } catch (IndexOutOfBoundsException iob) {
                StringBuffer exceptionBuffer =</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\pop3server\POP3HandlerChain.java</td><td><a href="./xref/org/apache/james/pop3server/POP3HandlerChain.html#145">145</a></td></tr><tr class="a"><td>org\apache\james\smtpserver\SMTPHandlerChain.java</td><td><a href="./xref/org/apache/james/smtpserver/SMTPHandlerChain.html#135">135</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>            }
        }

        // the size must be greater than 1 because we added UnknownCmdHandler to
        // the map

        if (commandHandlerMap.size() &lt; 2) {
            if (getLogger().isErrorEnabled()) {
                getLogger().error(&quot;No commandhandlers configured&quot;);
            }
            throw new ConfigurationException(&quot;No commandhandlers configured&quot;);
        } else {
            boolean found = true;
            for (int i = 0; i &lt; mandatoryCommands.length; i++) {
                if (!commandHandlerMap.containsKey(mandatoryCommands[i])) {
                    if (getLogger().isErrorEnabled()) {
                        getLogger().error(
                                &quot;No commandhandlers configured for the command:&quot;
                                        + mandatoryCommands[i]);
                    }
                    found = false;
                    break;
                }
            }

            if (!found) {
                throw new ConfigurationException(
                        &quot;No commandhandlers configured for mandatory commands&quot;);
            }</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\JDBCAlias.java</td><td><a href="./xref/org/apache/james/transport/mailets/JDBCAlias.html#85">85</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\JDBCVirtualUserTable.java</td><td><a href="./xref/org/apache/james/transport/mailets/JDBCVirtualUserTable.html#123">123</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        try {
            ServiceManager componentManager = (ServiceManager)getMailetContext().getAttribute(Constants.AVALON_COMPONENT_MANAGER);
            // Get the DataSourceSelector service
            DataSourceSelector datasources = (DataSourceSelector)componentManager.lookup(DataSourceSelector.ROLE);
            // Get the data-source required.
            datasource = (DataSourceComponent)datasources.select(datasourceName);

            conn = datasource.getConnection();

            // Check if the required table exists. If not, complain.
            DatabaseMetaData dbMetaData = conn.getMetaData();
            // Need to ask in the case that identifiers are stored, ask the DatabaseMetaInfo.
            // Try UPPER, lower, and MixedCase, to see if the table is there.
            if (!(theJDBCUtil.tableExists(dbMetaData, tableName))) {
                StringBuffer exceptionBuffer =
                                              new StringBuffer(128)
                                              .append(&quot;Could not find table '&quot;)
                                              .append(tableName)
                                              .append(&quot;' in datasource '&quot;)
                                              .append(datasourceName)
                                              .append(&quot;'&quot;);
                throw new MailetException(exceptionBuffer.toString());
            }</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#322">322</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\WhiteListManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/WhiteListManager.html#597">597</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>                        String recipientUser = recipientMailAddress.getUser().toLowerCase(Locale.US);
                        String recipientHost = recipientMailAddress.getHost().toLowerCase(Locale.US);
                        
                        if (getMailetContext().isLocalServer(recipientHost)) {
                            // not a remote recipient, so skip
                            continue;
                        }
                        
                        if (conn == null) {
                            conn = datasource.getConnection();
                        }
                        
                        if (selectStmt == null) {
                            selectStmt = conn.prepareStatement(selectByPK);
                        }
                        selectStmt.setString(1, senderUser);
                        selectStmt.setString(2, senderHost);
                        selectStmt.setString(3, recipientUser);
                        selectStmt.setString(4, recipientHost);
                        selectRS = selectStmt.executeQuery();
                        if (!selectRS.next()) {</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\mailrepository\JDBCMailRepository.java</td><td><a href="./xref/org/apache/james/mailrepository/JDBCMailRepository.html#626">626</a></td></tr><tr class="a"><td>org\apache\james\mailrepository\JDBCMailRepository.java</td><td><a href="./xref/org/apache/james/mailrepository/JDBCMailRepository.html#730">730</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>                        ByteArrayOutputStream baos = new ByteArrayOutputStream();
                        ObjectOutputStream oos = new ObjectOutputStream(baos);
                        try {
                            if (mc instanceof MailImpl) {
                            oos.writeObject(((MailImpl)mc).getAttributesRaw());
                            } else {
                                HashMap temp = new HashMap();
                                for (Iterator i = mc.getAttributeNames(); i.hasNext(); ) {
                                    String hashKey = (String) i.next();
                                    temp.put(hashKey,mc.getAttribute(hashKey));
                                }
                                oos.writeObject(temp);
                            }
                            oos.flush();
                            ByteArrayInputStream attrInputStream =
                                new ByteArrayInputStream(baos.toByteArray());</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\pop3server\ListCmdHandler.java</td><td><a href="./xref/org/apache/james/pop3server/ListCmdHandler.html#50">50</a></td></tr><tr class="a"><td>org\apache\james\pop3server\StatCmdHandler.java</td><td><a href="./xref/org/apache/james/pop3server/StatCmdHandler.html#48">48</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>        if (session.getHandlerState() == POP3Handler.TRANSACTION) {
            long size = 0;
            int count = 0;
            try {
                for (Iterator i = session.getUserMailbox().iterator(); i.hasNext(); ) {
                    Mail mc = (Mail) i.next();
                    if (mc != POP3Handler.DELETED) {
                        size += mc.getMessageSize();
                        count++;
                    }
                }
                StringBuffer responseBuffer =
                    new StringBuffer(32)
                            .append(POP3Handler.OK_RESPONSE)
                            .append(&quot; &quot;)
                            .append(count)
                            .append(&quot; &quot;)
                            .append(size);
                responseString = responseBuffer.toString();
                session.writeResponse(responseString);</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\smtpserver\core\DataCmdHandler.java</td><td><a href="./xref/org/apache/james/smtpserver/core/DataCmdHandler.html#149">149</a></td></tr><tr class="a"><td>org\apache\james\smtpserver\core\SendMailHandler.java</td><td><a href="./xref/org/apache/james/smtpserver/core/SendMailHandler.html#96">96</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>                   StringBuffer errorBuffer =
                     new StringBuffer(256)
                         .append(&quot;Rejected message from &quot;)
                         .append(session.getState().get(SMTPSession.SENDER).toString())
                         .append(&quot; from host &quot;)
                         .append(session.getRemoteHost())
                         .append(&quot; (&quot;)
                         .append(session.getRemoteIPAddress())
                         .append(&quot;) exceeding system maximum message size of &quot;)
                         .append(session.getConfigurationData().getMaxMessageSize());
                   getLogger().error(errorBuffer.toString());
              } else {
                   responseString = &quot;451 &quot;+DSNStatus.getStatus(DSNStatus.TRANSIENT,DSNStatus.UNDEFINED_STATUS)+&quot; Error processing message.&quot;;</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\util\SqlResources.java</td><td><a href="./xref/org/apache/james/util/SqlResources.html#301">301</a></td></tr><tr class="a"><td>org\apache\james\util\XMLResources.java</td><td><a href="./xref/org/apache/james/util/XMLResources.html#275">275</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>    static private String substituteSubString( String input, 
                                               String find,
                                               String replace )
    {
        int find_length = find.length();
        int replace_length = replace.length();

        StringBuffer output = new StringBuffer(input);
        int index = input.indexOf(find);
        int outputOffset = 0;

        while ( index &gt; -1 ) {
            output.replace(index + outputOffset, index + outputOffset + find_length, replace);
            outputOffset = outputOffset + (replace_length - find_length);

            index = input.indexOf(find, index + find_length);
        }

        String result = output.toString();
        return result;
    }

    /**
     * Returns a named string for the specified connection, replacing
     * parameters with the values set.
     * 
     * @param name   the name of the String resource required.
     * @return the requested resource
     */
    public String getString(String name)</pre></div></td></tr><table class="bodyTable"></p><p><table class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>org\apache\james\transport\mailets\CommandListservManager.java</td><td><a href="./xref/org/apache/james/transport/mailets/CommandListservManager.html#407">407</a></td></tr><tr class="a"><td>org\apache\james\transport\mailets\CommandListservProcessor.java</td><td><a href="./xref/org/apache/james/transport/mailets/CommandListservProcessor.html#520">520</a></td></tr><tr class="b"><td colspan='2'><div class="source"><pre>    }

    /**
     * Retrieves a data field, potentially defined by a super class.
     * @return null if not found, the object otherwise
     */
    protected static Object getField(Object instance, String name) throws IllegalAccessException {
        Class clazz = instance.getClass();
        Field[] fields;
        while (clazz != null) {
            fields = clazz.getDeclaredFields();
            for (int index = 0; index &lt; fields.length; index++) {
                Field field = fields[index];
                if (field.getName().equals(name)) {
                    field.setAccessible(true);
                    return field.get(instance);
                }
            }
            clazz = clazz.getSuperclass();
        }

        return null;
    }</pre></div></td></tr><table class="bodyTable"></p></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">&#169;  
          2002-2006
    
          Apache Software Foundation
          
  

  
    
  
  
  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
