<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">










<html>
  <head>
    <title>James Server - 
  Sendmail integration</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
          <meta name="author" content="
  Danny Angus" />
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
      </head>
  <body class="composite">
    <div id="banner">
                  <a href="http://james.apache.org/index.html" id="bannerLeft">
    
                                            <img src="images/james-server-logo.gif" alt="" />
    
            </a>
                        <a href="http://www.apache.org/index.html" id="bannerRight">
    
                                            <img src="images/asf-logo-reduced.gif" alt="" />
    
            </a>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
          
  

  
    
  
  
            <div class="xleft">
        Last Published: 07/26/2006
                      </div>
            <div class="xright">      <a href="http://james.apache.org/index.html">JAMES Project</a>
          |
          <a href="">Server</a>
          |
          <a href="http://james.apache.org/jspf/index.html">jSPF</a>
          |
          <a href="http://james.apache.org/mime4j/index.html">Mime4J</a>
          |
          <a href="http://james.apache.org/jsieve/index.html">JSieve</a>
          |
          <a href="http://james.apache.org/postage/index.html">Postage</a>
          
  

  
    
  
  
  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
           
  

  
    
  
  
                   <h5>James</h5>
        <ul>
              
    <li class="none">
              <a href="index.html">Overview</a>
        </li>
              
    <li class="none">
              <a href="FAQ.html">James FAQ</a>
        </li>
              
    <li class="none">
              <a href="mail.html">Mailing Lists</a>
        </li>
              
    <li class="none">
              <a href="http://wiki.apache.org/james">Wiki</a>
        </li>
          </ul>
          <h5>Documentation</h5>
        <ul>
              
    <li class="none">
              <a href="documentation_2_1.html">James</a>
        </li>
              
    <li class="none">
              <a href="design_objectives.html">Design</a>
        </li>
              
    <li class="none">
              <a href="document_archive.html">Document Archive</a>
        </li>
          </ul>
          <h5>Documentation 2.3B</h5>
        <ul>
              
    <li class="none">
              <a href="documentation_2_3.html">James</a>
        </li>
              
    <li class="none">
              <a href="design_objectives_2_3.html">Design</a>
        </li>
              
    <li class="none">
              <a href="apidocs/index.html">James Javadocs</a>
        </li>
              
    <li class="none">
              <a href="rfclist.html">Useful RFCs</a>
        </li>
          </ul>
          <h5>Project</h5>
        <ul>
              
    <li class="none">
              <a href="http://issues.apache.org/jira/browse/JAMES">Bug Database</a>
        </li>
              
    <li class="none">
              <a href="http://svn.apache.org/viewvc/james/server/">Source Code</a>
        </li>
              
    <li class="none">
              <a href="changelog.html">Changelog</a>
        </li>
              
    <li class="none">
              <a href="todo.html">TODO</a>
        </li>
          </ul>
          <h5>Project Documentation</h5>
        <ul>
              
                
              
      
            
      
            
      
            
      
            
      
            
      
            
      
              
        <li class="collapsed">
              <a href="project-info.html">Project Information</a>
              </li>
              
                
              
      
            
      
            
      
            
      
              
        <li class="collapsed">
              <a href="project-reports.html">Project Reports</a>
              </li>
          </ul>
                                       <a href="http://maven.apache.org/" title="Built by Maven" id="poweredBy">
            <img alt="Built by Maven" src="./images/logos/maven-feather.png"></img>
          </a>
                       
  

  
    
  
  
        </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        

 



<a name="The problem"></a><div class="section"><h2>The problem</h2>

  <p>
    This document explains how to configure sendmail to route all mail generated by /usr/sbin/sendmail or local mail on a host through James on the same host, including mail to local addresses without @host.<br></br>
    All sendmail configuration file locations are for Redhat Linux 7.2, other installations may have different locations.<br></br>
    <b>We take no responsibility for the quality of the information in this document. </b><br></br><b>You should back-up any configuration files *before* you alter them.</b>
  </p>
</div>

<a name="Solution"></a><div class="section"><h2>Solution</h2>
<a name="Step 1: Stop sendmail from running as an SMTP daemon"></a><div class="section"><h3>Step 1: Stop sendmail from running as an SMTP daemon</h3>
<p>
Ok so you want to use James for everything, including delivering mail from localhost to local users.<br></br>
Well the first step is to stop sendmail from starting up as the SMTP Daemon on port 25, otherwise it will route mail to itself and who knows what will happen then.<br></br>
Open the sendmail configuration file <b>/etc/sysconfig/sendmail</b>
Change the line:<div class="source"><pre>DAEMON=yes</pre></div>into<div class="source"><pre>DAEMON=no</pre></div>
Restart sendmail with:<div class="source"><pre>[root@apache root]# /etc/rc.d/init.d/sendmail restart</pre></div>This will make sendmail process its outgoing queue, but not listen on port 25 for incoming mail.
</p>
</div>
<a name="Step 2: Set up sendmail to use relay"></a><div class="section"><h3>Step 2: Set up sendmail to use relay</h3>
<p>
Ok, so far so good, now you need to tell sendmail to relay everything, regardless of its rules, through James. James will take the roles of &quot;local relay&quot; (destination for all unqualified local addresses), &quot;mail hub&quot; (destination for all qualified local addresses) and &quot;smart relay&quot; (destination for all other mail) for this instance of sendmail, thereby catching everything.<br></br>
So open <b>/etc/sendmail.cf</b> and..
<ul>
<li>Look for the line beginning <b>DS</b> make this line <b>DSesmtp:localhost</b></li>
<li>Look for the line beginning <b>DR</b> make this line <b>DResmtp:localhost</b></li>
<li>Look for the line beginning <b>DH</b> make this line <b>DHesmtp:localhost</b></li>
</ul>
Now that wasn't too hard was it?<br></br>
What we have done is to tell sendmail to use its &quot;mailer&quot; called <b>esmtp</b> to relay mail using ESMTP to localhost for each role.<br></br>
Of course no-one in their right mind would relay mail to localhost, because it would loop forever right?

</div>

<a name="Step 3: Stop sendmail complaining about mail apparently looping back"></a><div class="section"><h3>Step 3: Stop sendmail complaining about mail apparently looping back</h3>

The developers of sendmail have, wisely, built sendmail in such a way as to prevent, by default, mail being sent by sendmail back to itself, this is done by making a quick check on outgoing mail to see if its destination is our machine. If it is you'll see this message <b><i>config error: mail loops back to me</i></b> when you try to send mail.<br></br>
But we *want* to relay mail to localhost, and because sendmail isn't receiving our mail, James is, we won't be creating a loop. (make sure you've followed step one though).<br></br>
So open <b>/etc/sendmail.cf</b> again and go to the bottom of the file, start scrolling upwards until you see the declaration of the esmtp mailer it'll look something like this
<div class="source"><pre>
Mesmtp,     P=[IPC], F=mDFMuXa, S=EnvFromSMTP/HdrFromSMTP, R=EnvToSMTP, E=\r\n, L=990,
        T=DNS/RFC822/SMTP,
        A=TCP $h
</pre></div>
You need to change it so its more like this:  :-D
<div class="source"><pre>
Mesmtp,     P=[IPC], F=kmDFMuXa, S=EnvFromSMTP/HdrFromSMTP, R=EnvToSMTP, E=\r\n, L=990,
        T=DNS/RFC822/SMTP,
        A=TCP $h
</pre></div>
But seriously, we've added a <b>k</b> to the &quot;F=&quot; list <b>F=mDFMuXa</b> becomes <b>F=kmDFMuXa</b><br></br>
And again, thats it, sendmail will now skip the loopback test on mail leaving through the esmtp mailer.

Now you have to make some tests.<br></br>Try each of the following, replace names in [] with names of the kind described.
<div class="source"><pre>/[root@apache root]# mail -v [real-localusername]

[root@apache root]# mail -v [nonexistant-localusername]

[root@apache root]# mail -v [real-localusername]@localhost

[root@apache root]# mail -v [real-localusername]@[myhostname.mydomainname]

[root@apache root]# mail -v [real-username]@[real-remote-account]
</pre></div>
Sendmail echoes each conversation to STDOUT so you can see what its trying to do with each mail.<br></br>

</div>

<a name="Step 4: If that wasn't enough James requires SMTP AUTH"></a><div class="section"><h3>Step 4: If that wasn't enough James requires SMTP AUTH</h3>
<p>
SMTP AUTH is a different Kettle of Fish.<br></br>
The scenario is that you're using SMTP AUTH on James to restrict SMTP relaying to authenticated users, allowing them to connect from any IP address but still not letting James become an open relay for spam, cool.<br></br>
However you now want to let sendmail relay through James, so you need to tell it how to authenticate.<br></br>
So open <b>/etc/sendmail.cf</b> <i>again</i> and this time..
<ul>
<li>Look for the line beginning <b>O AuthMechanisms=</b> If this line is commented out with a leading <b>#</b>, remove the <b>#</b> then make sure LOGIN and PLAIN are at the beginning of this line like this <b>O AuthMechanisms=LOGIN PLAIN GSSAPI KERBEROS_V4 DIGEST-MD5 CRAM-MD5</b></li>
<li>Look for the line beginning <b>O DefaultAuthInfo=</b> If this line is commented out with a leading <b>#</b>, remove the <b>#</b> then make this line <b>O DefaultAuthInfo=/etc/mail/default-auth-info</b></li>
<li>Create a user account on James for sendmail to login as.</li>
<li>Create the file <b>/etc/mail/default-auth-info</b></li>
<li>It should contain this<div class="source"><pre>username
username
password
localhost</pre></div>Yes the username appears twice.</li>
<li>Replace username and password with the details of the account you just created.</li>
<li>This file has to be chmod'ed 600 (-rw------) or sendmail won't read it.</li>
<li>Look for the line beginning <b>O AuthOptions=</b> If this line is commented out with a leading <b>#</b>, remove the <b>#</b> and it should be <b>O AuthOptions=A</b></li>
</ul>

<h1><i><b>Ta-da!</b></i></h1> Now you're ready to run the tests in Step3, all of the mail should be accepted, the most likely rejection will be the final one.

</div>
Thats it, good luck and happy mailing :)<br></br>Danny Angus
</div>



      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">&#169;  
          2002-2006
    
          Apache Software Foundation
          
  

  
    
  
  
  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
